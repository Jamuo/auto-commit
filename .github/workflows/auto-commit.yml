name: Daily Auto Commit

on:
  # æ¯å¤©è¿è¡Œä¸€æ¬¡ - åŒ—äº¬æ—¶é—´ 9:00ï¼ˆUTC 1:00ï¼‰
  schedule:
    - cron: '0 1 * * *'  # UTC 1:00 = åŒ—äº¬æ—¶é—´ 9:00

  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:

jobs:
  auto_commit:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½®ä¸ºåŒ—äº¬æ—¶é—´
        run: |
          sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

      - name: é…ç½® Git
        run: |
          git config --local user.name "${{ github.actor }}"
          git config --local user.email "${{ github.actor }}@users.noreply.github.com"

      - name: è·å–é‡åº†å®æ—¶å¤©æ°”
        id: weather
        run: |
          LAT=29.56301
          LON=106.55156
          DATA=$(curl -s "https://api.open-meteo.com/v1/forecast?latitude=$LAT&longitude=$LON&current=temperature_2m,weathercode&timezone=auto")
          TEMP=$(echo "$DATA" | jq '.current.temperature_2m')
          CODE=$(echo "$DATA" | jq '.current.weathercode')

          case $CODE in
            0) DESC="â˜€ï¸ æ™´å¤©" ;;
            1|2|3) DESC="â›… å¤šäº‘" ;;
            45|48) DESC="ğŸŒ«ï¸ é›¾éœ¾" ;;
            51|53|55|61|63|65) DESC="ğŸŒ¦ï¸ å°é›¨" ;;
            80|81|82) DESC="ğŸŒ§ï¸ é˜µé›¨" ;;
            95|96|99) DESC="â›ˆï¸ é›·æš´" ;;
            *) DESC="ğŸŒˆ æœªçŸ¥å¤©æ°”" ;;
          esac

          echo "weather_desc=$DESC" >> $GITHUB_OUTPUT
          echo "weather_temp=$TEMPÂ°C" >> $GITHUB_OUTPUT

      - name: æ‰§è¡Œæ¯æ—¥æäº¤ä»»åŠ¡
        run: |
          echo "======================================"
          echo "å¼€å§‹æ¯æ—¥è‡ªåŠ¨æäº¤ä»»åŠ¡"
          echo "æ—¥æœŸ: $(date '+%Y-%m-%d')"
          echo "======================================"
          echo ""

          # éšæœºç¡®å®šä»Šå¤©æäº¤çš„æ¬¡æ•°ï¼ˆ1-10æ¬¡ï¼‰
          NUM_COMMITS=$((RANDOM % 10 + 1))
          echo "ğŸ“ ä»Šå¤©è®¡åˆ’æäº¤æ¬¡æ•°: $NUM_COMMITS"
          echo ""

          # åŠ±å¿—è¯­æ•°ç»„
          MSGS=(
            "ğŸŒŸ Keep going, everything you need will come to you."
            "ğŸ’ª Believe in yourself!"
            "ğŸš€ Push your limits!"
            "ğŸ”¥ Focus and win."
            "ğŸ€ Good things take time."
            "ğŸ± Stay curious."
            "ğŸ§  Learn something new today."
            "âœ¨ You are unstoppable."
            "ğŸ’¯ Progress, not perfection."
            "ğŸ¯ Stay focused and never give up."
          )

          # æäº¤ä¿¡æ¯æ•°ç»„
          COMMIT_MSGS=(
            "Update code"
            "Fix bug"
            "Add feature"
            "Improve performance"
            "Refactor code"
            "Update documentation"
            "Fix typo"
            "Add comments"
            "Optimize code"
            "Clean up code"
          )

          # åˆ›å»º log.txtï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if [ ! -f "log.txt" ]; then
            echo "# Auto Commit Log" > log.txt
            echo "Started on: $(date '+%Y-%m-%d %H:%M:%S')" >> log.txt
            echo "========================================" >> log.txt
            echo "" >> log.txt
          fi

          # æ‰§è¡Œæäº¤
          SUCCESS_COUNT=0

          for i in $(seq 1 $NUM_COMMITS); do
            echo "[$i/$NUM_COMMITS] å‡†å¤‡æäº¤..."

            # éšæœºé€‰æ‹©æäº¤ä¿¡æ¯å’ŒåŠ±å¿—è¯­
            COMMIT_MSG="${COMMIT_MSGS[$RANDOM % ${#COMMIT_MSGS[@]}]}"
            MOTIVATE_MSG="${MSGS[$RANDOM % ${#MSGS[@]}]}"

            # ç”Ÿæˆæäº¤å†…å®¹
            TODAY=$(date '+%Y-%m-%dï¼ˆ%Aï¼‰')
            TIME=$(date '+%H:%M:%S')
            LUNAR="å†œå†ï¼š$(date +'%m')æœˆ$(date +'%d')æ—¥"

            # å†™å…¥æ—¥å¿—
            echo "ğŸ“… $TODAY" >> log.txt
            echo "â° $TIME" >> log.txt
            echo "ğŸ—“ï¸ $LUNAR" >> log.txt
            echo "â›… å¤©æ°”ï¼š${{ steps.weather.outputs.weather_desc }}ï¼Œ${{ steps.weather.outputs.weather_temp }}" >> log.txt
            echo "$MOTIVATE_MSG" >> log.txt

            # æ›´æ–°æäº¤è®¡æ•°
            COUNT_FILE=".github/commit_count.txt"
            if [ -f "$COUNT_FILE" ]; then
              COUNT=$(cat $COUNT_FILE)
            else
              COUNT=0
            fi
            COUNT=$((COUNT + 1))
            echo "$COUNT" > $COUNT_FILE
            echo "ğŸ”¢ ç¬¬ $COUNT æ¬¡æäº¤" >> log.txt
            echo "----------------------------------------" >> log.txt

            # Git æäº¤
            git add log.txt $COUNT_FILE

            if git commit -m "ğŸ“… $COMMIT_MSG - $(date '+%Y-%m-%d')"; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
              echo "âœ… æˆåŠŸ: $COMMIT_MSG"
            else
              echo "âš ï¸  æäº¤å¤±è´¥"
            fi

            # é™¤äº†æœ€åä¸€æ¬¡ï¼Œå…¶ä»–æäº¤åéƒ½ç­‰å¾…ä¸€æ®µéšæœºæ—¶é—´ï¼ˆ30-180ç§’ï¼‰
            if [ $i -lt $NUM_COMMITS ]; then
              WAIT_TIME=$((RANDOM % 151 + 30))
              echo "â³ ç­‰å¾… ${WAIT_TIME} ç§’åç»§ç»­..."
              sleep $WAIT_TIME
            fi

            echo ""
          done

          echo "======================================"
          echo "âœ… æäº¤ä»»åŠ¡å®Œæˆ!"
          echo "æˆåŠŸ: $SUCCESS_COUNT/$NUM_COMMITS"
          echo "å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "======================================"

      - name: æ¨é€ä»£ç 
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¤ æ­£åœ¨æ¨é€åˆ°è¿œç¨‹ä»“åº“..."
          git remote set-url origin https://x-access-token:$TOKEN@github.com/${{ github.repository }}.git
          git push origin HEAD:${{ github.ref_name }}
          echo "âœ… æ¨é€å®Œæˆ!"
